<ng-container *ngIf="loading(); else formTpl">
  <mat-card class="skeleton-card">
    <mat-card-header>
      <mat-card-title>
        <div class="skeleton skeleton-title"></div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="skeleton-row">
        <div class="skeleton skeleton-input"></div>
        <div class="skeleton skeleton-input"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton skeleton-input"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton skeleton-input"></div>
        <div class="skeleton skeleton-input"></div>
      </div>
      <div class="skeleton-row">
        <div class="skeleton skeleton-input"></div>
        <div class="skeleton skeleton-btn"></div>
      </div>
    </mat-card-content>
    <mat-card-actions align="end">
      <div class="skeleton skeleton-btn-lg"></div>
    </mat-card-actions>
  </mat-card>
</ng-container>

<ng-template #formTpl>
<form (submit)="$event.preventDefault(); onSubmit()" class="engineer-form fade-in" novalidate>
  <mat-card>
    <mat-card-header>
      <mat-card-title>Frontend Engineer Form</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().firstName) && hasError('firstName')">
          <mat-label>First Name</mat-label>
          <mat-icon matPrefix>person</mat-icon>
          <input matInput 
                 [value]="formState().firstName"
                 (input)="updateField('firstName', $any($event.target).value); showInlineErrors.set(true)"
                 (blur)="showInlineErrors.set(true)"
                 placeholder="e.g. John"
                 required>
          <mat-error *ngIf="(showInlineErrors() || formState().firstName) && hasError('firstName')">
            {{ getErrorMessage('firstName') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('firstName') && formState().firstName" align="end">
            ✓
          </mat-hint>
          <mat-hint *ngIf="!formState().firstName" align="start">
            Only Latin letters, first letter uppercase
          </mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().lastName) && hasError('lastName')">
          <mat-label>Last Name</mat-label>
          <mat-icon matPrefix>badge</mat-icon>
          <input matInput 
                 [value]="formState().lastName"
                 (input)="updateField('lastName', $any($event.target).value); showInlineErrors.set(true)"
                 (blur)="showInlineErrors.set(true)"
                 placeholder="e.g. Doe"
                 required>
          <mat-error *ngIf="(showInlineErrors() || formState().lastName) && hasError('lastName')">
            {{ getErrorMessage('lastName') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('lastName') && formState().lastName" align="end">
            ✓
          </mat-hint>
          <mat-hint *ngIf="!formState().lastName" align="start">
            Only Latin letters, first letter uppercase
          </mat-hint>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().dateOfBirth) && hasError('dateOfBirth')">
          <mat-label>Date of Birth</mat-label>
          <mat-icon matPrefix>cake</mat-icon>
          <input matInput 
                 data-cy="dateOfBirth"
                 [matDatepicker]="picker" 
                 [value]="formState().dateOfBirth"
                 (dateChange)="onDateChange($event); showInlineErrors.set(true)"
                 (blur)="showInlineErrors.set(true)"
                 [max]="maxDate"
                 required>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="(showInlineErrors() || formState().dateOfBirth) && hasError('dateOfBirth')">
            {{ getErrorMessage('dateOfBirth') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('dateOfBirth') && formState().dateOfBirth" align="end">
            ✓
          </mat-hint>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().framework) && hasError('framework')">
          <mat-label>Framework</mat-label>
          <mat-icon matPrefix>code</mat-icon>
          <mat-select 
            data-cy="framework"
            [value]="formState().framework"
            (selectionChange)="onFrameworkChange($event.value); showInlineErrors.set(true)"
            (openedChange)="!$event && showInlineErrors.set(true)"
            required>
            <mat-option *ngFor="let framework of getFrameworkKeys()" [value]="framework">
              {{ framework | titlecase }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="(showInlineErrors() || formState().framework) && hasError('framework')">
            {{ getErrorMessage('framework') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('framework') && formState().framework" align="end">
            ✓
          </mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().version) && hasError('version')">
          <mat-label>Version</mat-label>
          <mat-icon matPrefix>tag</mat-icon>
          <mat-select 
            data-cy="version"
            [value]="formState().version"
            (selectionChange)="onVersionChange($event.value); showInlineErrors.set(true)"
            (openedChange)="!$event && showInlineErrors.set(true)"
            [disabled]="!formState().framework"
            required>
            <mat-option *ngFor="let version of availableVersions()" [value]="version">
              {{ version }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="(showInlineErrors() || formState().version) && hasError('version')">
            {{ getErrorMessage('version') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('version') && formState().version" align="end">
            ✓
          </mat-hint>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field" [class.invalid]="(showInlineErrors() || formState().email) && hasError('email')">
          <mat-label>Email</mat-label>
          <mat-icon matPrefix>email</mat-icon>
          <input matInput 
                 type="email"
                 [value]="formState().email"
                 (input)="updateField('email', $any($event.target).value); showInlineErrors.set(true)"
                 (blur)="showInlineErrors.set(true)"
                 placeholder="e.g. test2@test.test"
                 required>
          <mat-error *ngIf="(showInlineErrors() || formState().email) && hasError('email')">
            {{ getErrorMessage('email') }}
          </mat-error>
          <mat-hint *ngIf="!hasError('email') && formState().email" align="end">
            ✓
          </mat-hint>
          <mat-hint *ngIf="emailValidating()" align="start">
            Validating email...
          </mat-hint>
          <mat-hint *ngIf="!formState().email && !emailValidating()" align="start">
            Enter a valid email
          </mat-hint>
        </mat-form-field>
      </div>

      <div class="hobbies-section" [class.invalid]="(showInlineErrors() || formState().hobbies.length > 0) && hasError('hobbies')">
        <h3>Hobbies</h3>
        <div class="hobby-inputs">
          <mat-form-field appearance="outline" class="hobby-field" [class.invalid]="(newHobby.touched || showInlineErrors()) && newHobby.invalid">
            <mat-label>Hobby</mat-label>
            <mat-icon matPrefix>sports</mat-icon>
            <input matInput 
                   data-cy="hobby"
                   [formControl]="newHobby"
                   placeholder="e.g. football"
                   (input)="showInlineErrors.set(true)"
                   (blur)="showInlineErrors.set(true)">
            <mat-error *ngIf="(newHobby.touched || showInlineErrors()) && newHobby.hasError('required')">
              Please specify a hobby
            </mat-error>
            <mat-error *ngIf="(newHobby.touched || showInlineErrors()) && newHobby.hasError('invalidHobby')">
              Hobby must contain only Latin letters, first letter uppercase
            </mat-error>
            <mat-hint *ngIf="!newHobby.value" align="start">
              Only Latin letters, first letter uppercase
            </mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="duration-field" [class.invalid]="(newHobbyDuration.touched || showInlineErrors()) && newHobbyDuration.invalid">
            <mat-label>Duration (months)</mat-label>
            <mat-icon matPrefix>schedule</mat-icon>
            <input matInput 
                   data-cy="hobby-duration"
                   [formControl]="newHobbyDuration"
                   placeholder="e.g. 2"
                   (input)="showInlineErrors.set(true)"
                   (blur)="showInlineErrors.set(true)">
            <mat-error *ngIf="(newHobbyDuration.touched || showInlineErrors()) && newHobbyDuration.hasError('required')">
              Please specify duration
            </mat-error>
            <mat-error *ngIf="(newHobbyDuration.touched || showInlineErrors()) && newHobbyDuration.hasError('pattern')">
              Enter a valid number (digits only)
            </mat-error>
            <mat-hint *ngIf="!newHobbyDuration.value" align="start">
              Digits only
            </mat-hint>
          </mat-form-field>

          <button mat-raised-button 
                  color="primary" 
                  (click)="addHobby()" 
                  [disabled]="newHobby.invalid || newHobbyDuration.invalid"
                  data-cy="add-hobby">
            <mat-icon>add</mat-icon> Add
          </button>
        </div>
        
        <div class="hobbies-list">
          <div class="hobby-chips">
            <div *ngFor="let hobby of hobbiesList(); let i = index" 
                 class="hobby-chip"
                 [class.invalid-hobby]="!isValidName(hobby.name)"
                 data-cy="hobby-chip">
              <span class="hobby-text">{{ hobby.name }} ({{ hobby.duration }})</span>
              <button class="remove-button" 
                      [attr.aria-label]="'Remove ' + hobby.name"
                      (click)="removeHobby(i); $event.stopPropagation()"
                      title="Remove hobby">
                ×
              </button>
            </div>
          </div>
        </div>
        
        <div class="hobbies-error" *ngIf="(showInlineErrors() || formState().hobbies.length > 0) && hasError('hobbies')">
          {{ getErrorMessage('hobbies') }}
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-raised-button color="primary" type="submit" data-cy="submit" [disabled]="!isFormValid() || emailValidating()">
        <mat-icon>send</mat-icon> Submit
      </button>
    </mat-card-actions>

    <!-- Aggregated form errors displayed under the submit button -->
    <div class="form-errors" *ngIf="showInlineErrors() && errorsList().length > 0">
      <ul>
        <li *ngFor="let err of errorsList()">{{ err }}</li>
      </ul>
    </div>
  </mat-card>
</form>
</ng-template>
